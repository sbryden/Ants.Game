import{P as f}from"./phaser-0RJB29YE.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const n of i.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&o(n)}).observe(document,{childList:!0,subtree:!0});function e(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(s){if(s.ep)return;s.ep=!0;const i=e(s);fetch(s.href,i)}})();var l=(r=>(r.IDLE="IDLE",r.WANDERING="WANDERING",r.FORAGING="FORAGING",r.RETURNING="RETURNING",r))(l||{});function at(r=.1){const t=()=>1+(Math.random()-.5)*2*r;return{taskAffinity:{gathering:t(),nursing:t(),digging:t(),building:t()},movementSpeed:t(),carryCapacity:t(),energyEfficiency:t(),pheromoneSensitivity:t(),wanderingRadius:t()}}function $(r,t,e){return Math.max(t,Math.min(e,r))}class ct{constructor(t,e,o,s,i=100){this.carriedFood=0,this.energy=100,this.lastEnergyConsumption=0,this.id=t,this.x=e,this.y=o,this.vx=0,this.vy=0,this.targetVx=0,this.targetVy=0,this.state=l.IDLE,this.colonyId=s,this.timeSinceDirectionChange=0,this.timeInCurrentState=0,this.perceptionRange=i,this.energy=100,this.lastEnergyConsumption=0,this.traits=at()}}const w={CANVAS_WIDTH:1024,CANVAS_HEIGHT:768,BACKGROUND_COLOR:"#2d4a2e"},P={INITIAL_ANT_COUNT:40,WORLD_WIDTH:102400,WORLD_HEIGHT:76800},X={SPEED:50,CHANGE_DIRECTION_INTERVAL:2,TURN_SPEED:.3},A={MAX_ENERGY:100,CONSUMPTION_RATES:{IDLE:.5,WANDERING:1,FORAGING:1.5,RETURNING:1},THRESHOLDS:{HUNGER:50},SPEED_MULTIPLIERS:{WELL_FED:1,NORMAL:.95,HUNGRY:.7,STARVING:.3},HUNGER_RETURN_CHANCE:.5,EATING_RECOVERY_RATE:20,FOOD_CONSUMPTION_RATE:.2},M={IDLE_TO_WANDERING_CHANCE:.5,WANDERING_MIN_DURATION:5,WANDERING_TO_FORAGING_CHANCE:.1,WANDERING_TO_RETURNING_CHANCE:.02,FORAGING_MIN_DURATION:5,FORAGING_TO_RETURNING_CHANCE:.1},W={HOME_ARRIVAL_DISTANCE:15,ENTRANCE_RADIUS:30,METRICS_SMOOTHING_FACTOR:.2,SAFETY_FOOD_PER_ANT:.2},B={OBSTACLE_DETECTION_RANGE:80,PERCEPTION_RANGE:100},G={BODY_RADIUS:3,HEAD_RADIUS:2,HEAD_COLOR:6636321},dt={PHEROMONE_DEPTH:5},x={NEST_RADIUS:20,NEST_BORDER_WIDTH:2,NEST_OPACITY:.6,ENTRANCE_RADIUS_MULTIPLIER:.4,ENTRANCE_OPACITY:.3},T={TITLE:{X:16,Y:16,FONT_SIZE:"32px",TEXT:"Ants!"},INSTRUCTIONS:{X:16,Y:56,FONT_SIZE:"16px",TEXT:"Watch the ants wander and return home... | Scroll/±= to zoom | WASD to pan"},LEGEND:{X:16,Y:84,FONT_SIZE:"12px"},DEBUG:{X:16,Y_OFFSET_FROM_BOTTOM:40,FONT_SIZE:"14px",BACKGROUND_COLOR:"#00000088",PADDING:{x:8,y:4}},UI_DEPTH:100},S={MIN_ZOOM:Math.min(w.CANVAS_WIDTH/P.WORLD_WIDTH,w.CANVAS_HEIGHT/P.WORLD_HEIGHT),MAX_ZOOM:5,ZOOM_STEP:.15,PAN_SPEED:1e3},O={GRID_CELL_SIZE:10,FOOD_DECAY_RATE:.05,NEST_DECAY_RATE:.03,DANGER_DECAY_RATE:.1,DEPOSITION_WANDERING:.5,DEPOSITION_FORAGING:.5,DEPOSITION_RETURNING:2,DIFFUSION_UPDATE_INTERVAL:3,DIFFUSION_RATE:.05,MAX_STRENGTH:20,MIN_STRENGTH:.001,RENDER_THRESHOLD:.01,VISUALIZATION_POWER:.5,MAX_OPACITY:.6},H={SAMPLE_DISTANCE:300,FOLLOW_STRENGTH:.6,EXPLORATION_RANDOMNESS:.08,GRADIENT_THRESHOLD:.005},y={INITIAL_FOOD_AMOUNT:100,SOURCE_RADIUS:15,HARVEST_RATE:1,HARVEST_DISTANCE:20,SPAWN_EDGE_PADDING:30,SPAWN_ATTEMPTS:10,SPAWN_BUFFER_DISTANCE:15},L={MAX_CAPACITY:5,CARRYING_INDICATOR_RADIUS:1.5,CARRYING_INDICATOR_COLOR:16729156},C={default:{id:"default",name:"Default",backgroundColor:2968110,antColors:{idle:8421504,wandering:9127187,foraging:4881486,returning:4286881},pheromoneColors:{food:16711680,nest:255,danger:16776960},colonyColors:{nest:7356948,border:9127187,entrance:0},foodColors:{food:13935988,border:9137991},obstacleColor:4868682,uiColors:{title:"#ffffff",text:"#cccccc",textDim:"#aaaaaa"}},highContrast:{id:"highContrast",name:"High Contrast",backgroundColor:1710618,antColors:{idle:11184810,wandering:16755268,foraging:4521796,returning:4491519},pheromoneColors:{food:16711765,nest:65535,danger:16776960},colonyColors:{nest:11167283,border:16755302,entrance:0},foodColors:{food:16764006,border:16750899},obstacleColor:6710886,uiColors:{title:"#ffffff",text:"#ffffff",textDim:"#cccccc"}},blackWhite:{id:"blackWhite",name:"Black & White",backgroundColor:0,antColors:{idle:5592405,wandering:10066329,foraging:13421772,returning:16777215},pheromoneColors:{food:12303291,nest:7829367,danger:16777215},colonyColors:{nest:6710886,border:11184810,entrance:0},foodColors:{food:14540253,border:16777215},obstacleColor:3355443,uiColors:{title:"#ffffff",text:"#dddddd",textDim:"#999999"}}},g={TITLE:{TEXT:"Ants.Game",FONT_SIZE:"56px",Y_POSITION:150},TAGLINE:{TEXT:"Observe. Adapt. Survive.",FONT_SIZE:"24px",Y_POSITION:220},START_BUTTON:{TEXT:"Start Simulation",FONT_SIZE:"28px",Y_POSITION:320,PADDING:{x:40,y:18},BACKGROUND_COLOR:"#4a7c4e",HOVER_COLOR:"#5a9c6e",BORDER_COLOR:"#ffffff",BORDER_WIDTH:2},CONFIG_BUTTON:{TEXT:"⚙ Configuration",FONT_SIZE:"20px",Y_POSITION:420},CONFIG_PANEL:{WIDTH:500,HEIGHT:450,BACKGROUND_COLOR:2763306,BACKGROUND_ALPHA:1,BORDER_COLOR:4881486,BORDER_WIDTH:3,PADDING:30},SLIDER:{WIDTH:400,HEIGHT:8,HANDLE_RADIUS:12,TRACK_COLOR:3355443,HANDLE_COLOR:4881486,HANDLE_HOVER_COLOR:5938286},BACKGROUND_SIM:{ANT_COUNT:15},DEPTHS:{BACKGROUND:0,UI_BASE:100,CONFIG_OVERLAY:200,CONFIG_PANEL:201}},I={TRAIT_INCREASE_RATE:.01,TRAIT_DECAY_RATE:.001,MIN_TRAIT_VALUE:.5,MAX_TRAIT_VALUE:2,HIGH_AFFINITY_THRESHOLD:1.3,EVOLUTION_UPDATE_INTERVAL:60};class lt{constructor(t,e,o){this.id=t,this.x=e,this.y=o,this.ants=[],this.foodStored=0,this.foodConsumedRate=0,this.foodGatheredRate=0,this.surplusRate=0,this.gatheredThisFrame=0,this.consumedThisFrame=0}spawnAnt(t){const e=new ct(t,this.x,this.y,this.id,B.PERCEPTION_RANGE);return this.ants.push(e),e}beginFrame(){this.gatheredThisFrame=0,this.consumedThisFrame=0}addFood(t){t<=0||(this.foodStored+=t,this.gatheredThisFrame+=t)}consumeFood(t){if(t<=0||this.foodStored<=0)return 0;const e=Math.min(t,this.foodStored);return this.foodStored-=e,this.consumedThisFrame+=e,e}finalizeFrame(t){const e=Math.max(t,1e-4),o=this.gatheredThisFrame/e,s=this.consumedThisFrame/e,i=W.METRICS_SMOOTHING_FACTOR;this.foodGatheredRate=this.lerp(this.foodGatheredRate,o,i),this.foodConsumedRate=this.lerp(this.foodConsumedRate,s,i),this.surplusRate=this.foodGatheredRate-this.foodConsumedRate}getHealthStatus(){const t=this.getPopulation();if(t===0)return"dead";if(this.foodStored===0)return"critical";const e=t*W.SAFETY_FOOD_PER_ANT;return this.foodStored<e?"struggling":"healthy"}getAverageEnergy(){const t=this.ants;return t.length===0?0:t.reduce((o,s)=>o+s.energy,0)/t.length}getAnts(){return[...this.ants]}getAntCount(){return this.ants.length}getPopulation(){return this.ants.length}lerp(t,e,o){return t+(e-t)*o}}class q{constructor(t,e,o,s,i){this.id=t,this.x=e,this.y=o,this.foodAmount=s,this.radius=i}harvest(t){const e=Math.min(t,this.foodAmount);return this.foodAmount-=e,e}isDepleted(){return this.foodAmount<=0}}var u=(r=>(r.FOOD="FOOD",r.NEST="NEST",r.DANGER="DANGER",r))(u||{});class ut{constructor(t,e,o){this.width=t,this.height=e,this.cellSize=o,this.gridWidth=Math.ceil(t/o),this.gridHeight=Math.ceil(e/o),this.grids=new Map;for(const s of Object.values(u))this.grids.set(s,new Float32Array(this.gridWidth*this.gridHeight));this.diffusionBuffer=new Float32Array(this.gridWidth*this.gridHeight)}deposit(t,e,o,s){const i=Math.floor(t/this.cellSize),n=Math.floor(e/this.cellSize);if(i<0||i>=this.gridWidth||n<0||n>=this.gridHeight)return;const h=this.grids.get(o);if(!h)return;const c=n*this.gridWidth+i;h[c]=Math.min(h[c]+s,O.MAX_STRENGTH)}sample(t,e,o){const s=Math.floor(t/this.cellSize),i=Math.floor(e/this.cellSize);if(s<0||s>=this.gridWidth||i<0||i>=this.gridHeight)return 0;const n=this.grids.get(o);if(!n)return 0;const h=i*this.gridWidth+s;return n[h]}decay(t,e,o){const s=this.grids.get(o);if(!s)return;const i=Math.pow(1-e,t);for(let n=0;n<s.length;n++)s[n]*=i,s[n]<O.MIN_STRENGTH&&(s[n]=0)}getGrid(t){return this.grids.get(t)}getGridWidth(){return this.gridWidth}getGridHeight(){return this.gridHeight}getCellSize(){return this.cellSize}diffuse(t,e){const o=this.grids.get(t);if(o){this.diffusionBuffer.fill(0);for(let s=0;s<this.gridHeight;s++)for(let i=0;i<this.gridWidth;i++){const n=s*this.gridWidth+i,h=o[n];let c=h,a=1;s>0&&(c+=o[(s-1)*this.gridWidth+i],a++),s<this.gridHeight-1&&(c+=o[(s+1)*this.gridWidth+i],a++),i>0&&(c+=o[s*this.gridWidth+(i-1)],a++),i<this.gridWidth-1&&(c+=o[s*this.gridWidth+(i+1)],a++);const d=c/a;this.diffusionBuffer[n]=h*(1-e)+d*e,this.diffusionBuffer[n]<O.MIN_STRENGTH&&(this.diffusionBuffer[n]=0)}o.set(this.diffusionBuffer)}}clear(){for(const t of this.grids.values())t.fill(0)}clearType(t){const e=this.grids.get(t);e&&e.fill(0)}}class et{constructor(t,e){this.foodSources=[],this.width=t,this.height=e,this.colonies=[],this.obstacles=[],this.pheromoneGrid=new ut(t,e,O.GRID_CELL_SIZE),this.nextAntId=0,this.nextFoodSourceId=0,this.cachedAnts=[],this.antsCacheDirty=!0}createColony(t,e){const o=this.colonies.length,s=new lt(o,t,e);return this.colonies.push(s),s}spawnAnt(t){const e=t.spawnAnt(this.nextAntId++);return this.antsCacheDirty=!0,e}removeAnt(t){const e=this.getColony(t.colonyId);if(!e)return;const o=e.ants.indexOf(t);o!==-1&&(e.ants.splice(o,1),this.antsCacheDirty=!0)}getAllAnts(){if(this.antsCacheDirty){this.cachedAnts=[];for(const t of this.colonies)this.cachedAnts.push(...t.getAnts());this.antsCacheDirty=!1}return this.cachedAnts}getColonies(){return[...this.colonies]}getColony(t){return this.colonies[t]}addObstacle(t){this.obstacles.push(t)}getObstacles(){return this.obstacles}getObstaclesNear(t,e,o){const s=[];for(const i of this.obstacles){const n=i.x-t,h=i.y-e;Math.sqrt(n*n+h*h)-i.radius<=o&&s.push(i)}return s}spawnFoodSource(){const t=y.SOURCE_RADIUS,e=y.SPAWN_EDGE_PADDING,o=y.SPAWN_ATTEMPTS;for(let h=0;h<o;h++){const c=e+Math.random()*(this.width-2*e),a=e+Math.random()*(this.height-2*e);if(this.isValidFoodSourceLocation(c,a,t)){const d=new q(`food_${this.nextFoodSourceId++}`,c,a,y.INITIAL_FOOD_AMOUNT,t);return this.foodSources.push(d),d}}const s=this.width-t-e,i=this.height-t-e,n=new q(`food_${this.nextFoodSourceId++}`,s,i,y.INITIAL_FOOD_AMOUNT,t);return this.foodSources.push(n),n}isValidFoodSourceLocation(t,e,o){const s=o+y.SPAWN_BUFFER_DISTANCE;for(const i of this.obstacles){const n=i.x-t,h=i.y-e;if(Math.sqrt(n*n+h*h)<s+i.radius)return!1}for(const i of this.colonies){const n=i.x-t,h=i.y-e;if(Math.sqrt(n*n+h*h)<s+W.ENTRANCE_RADIUS)return!1}return!0}getFoodSourcesNear(t,e,o){const s=[];for(const i of this.foodSources){const n=i.x-t,h=i.y-e;Math.sqrt(n*n+h*h)<=o&&s.push(i)}return s}}const ot=[0,Math.PI/4,Math.PI/2,3*Math.PI/4,Math.PI,-3*Math.PI/4,-Math.PI/2,-Math.PI/4];function z(r,t,e,o){const s=[];let i=0;for(const h of ot){const c=r.x+Math.cos(h)*o,a=r.y+Math.sin(h)*o,d=t.sample(c,a,e);s.push(d),d>i&&(i=d)}const n=Math.min(i,1);return{samples:s,maxConcentration:n}}function j(r,t=.01){if(r.maxConcentration<t)return null;let e=0,o=r.samples[0];for(let s=1;s<r.samples.length;s++)r.samples[s]>o&&(o=r.samples[s],e=s);return ot[e]}function J(r,t,e,o){if(t===null||Math.random()<o.explorationRandomness){const d=Math.random()*Math.PI*2,E=Math.cos(d)*e,R=Math.sin(d)*e;r.targetVx=E,r.targetVy=R;return}const s=Math.cos(t)*e,i=Math.sin(t)*e,n=o.followStrength,h=(Math.random()-.5)*Math.PI*.2,c=Math.cos(h)*e*(1-n)*.3,a=Math.sin(h)*e*(1-n)*.3;r.targetVx=s*n+c,r.targetVy=i*n+a}function K(r,t){const e=Math.random()*Math.PI*2;r.targetVx=Math.cos(e)*t.speed,r.targetVy=Math.sin(e)*t.speed}function Q(r,t,e,o){const s=t-r.x,i=e-r.y,n=Math.sqrt(s*s+i*i);n>0&&(r.targetVx=s/n*o.speed,r.targetVy=i/n*o.speed)}function Tt(r,t,e,o=10){const s=t-r.x,i=e-r.y;return s*s+i*i<o*o}function gt(r,t,e){const o=Math.min(1,t.turnSpeed*e*10);r.vx+=(r.targetVx-r.vx)*o,r.vy+=(r.targetVy-r.vy)*o}function ft(r,t){r.x+=r.vx*t,r.y+=r.vy*t}function Et(r,t){(r.x<0||r.x>t.width)&&(r.vx*=-1,r.x=Math.max(0,Math.min(t.width,r.x))),(r.y<0||r.y>t.height)&&(r.vy*=-1,r.y=Math.max(0,Math.min(t.height,r.y)))}function Nt(r,t,e){const o=t.getObstaclesNear(r.x,r.y,e);if(o.length===0)return null;let s=null,i=1/0;const n=Math.sqrt(r.vx*r.vx+r.vy*r.vy);if(n===0)return null;const h=r.vx/n,c=r.vy/n;for(const a of o){const d=a.x-r.x,E=a.y-r.y,R=Math.sqrt(d*d+E*E);(d*h+E*c)/R>.5&&R<i&&(i=R,s=a)}return s}function Ot(r,t,e){const o=t.x-r.x,s=t.y-r.y,i=Math.sqrt(o*o+s*s);if(i===0)return;const n=-s,h=o,a=(r.vx*n+r.vy*h)/i>=0?1:-1;r.targetVx=a*(n/i)*e.speed,r.targetVy=a*(h/i)*e.speed}function It(r,t){const e=t.getObstaclesNear(r.x,r.y,100);for(const o of e)if(o.containsPoint(r.x,r.y)){const s=r.x-o.x,i=r.y-o.y,n=Math.sqrt(s*s+i*i);if(n===0){const c=Math.random()*Math.PI*2;r.x=o.x+Math.cos(c)*(o.radius+1),r.y=o.y+Math.sin(c)*(o.radius+1)}else{const c=s/n,a=i/n;r.x=o.x+c*(o.radius+1),r.y=o.y+a*(o.radius+1)}const h=r.vx*s+r.vy*i;h<0&&(r.vx-=h/(n*n)*s,r.vy-=h/(n*n)*i,r.targetVx=r.vx,r.targetVy=r.vy)}}function tt(r,t,e){const o=t.getObstaclesNear(r.x,r.y,r.perceptionRange);let s=1/0;for(const a of o){const d=a.distanceToEdge(r.x,r.y);d<s&&(s=d)}const i=t.getColony(r.colonyId);let n=0,h=0;if(i){const a=i.x-r.x,d=i.y-r.y;n=Math.sqrt(a*a+d*d),h=Math.atan2(d,a)}const c=new Map;return c.set(u.FOOD,z(r,t.pheromoneGrid,u.FOOD,e)),c.set(u.NEST,z(r,t.pheromoneGrid,u.NEST,e)),c.set(u.DANGER,z(r,t.pheromoneGrid,u.DANGER,e)),{nearbyObstacles:o,nearestObstacleDistance:s,distanceToHome:n,directionToHome:h,pheromoneGradients:c}}const st={idleToWanderingChance:M.IDLE_TO_WANDERING_CHANCE,wanderingMinDuration:M.WANDERING_MIN_DURATION,wanderingToForagingChance:M.WANDERING_TO_FORAGING_CHANCE,wanderingToReturningChance:M.WANDERING_TO_RETURNING_CHANCE,foragingMinDuration:M.FORAGING_MIN_DURATION,foragingToReturningChance:M.FORAGING_TO_RETURNING_CHANCE};function Rt(r,t,e=st){const o=r.state,s=r.timeInCurrentState;switch(o){case l.IDLE:if(Math.random()<e.idleToWanderingChance*t)return l.WANDERING;break;case l.WANDERING:if(r.energy<A.THRESHOLDS.HUNGER){const i=A.HUNGER_RETURN_CHANCE*t;if(Math.random()<i)return l.RETURNING}if(s>=e.wanderingMinDuration){if(Math.random()<e.wanderingToForagingChance*t)return l.FORAGING;if(Math.random()<e.wanderingToReturningChance*t)return l.RETURNING}break;case l.FORAGING:if(r.energy<A.THRESHOLDS.HUNGER){const i=A.HUNGER_RETURN_CHANCE*2*t;if(Math.random()<i)return l.RETURNING}if(s>=e.foragingMinDuration&&Math.random()<e.foragingToReturningChance*t)return l.RETURNING;break;case l.RETURNING:break}return o}function v(r,t){r.state!==t&&(r.state=t,r.timeInCurrentState=0)}function At(r,t,e){return t.getFoodSourcesNear(r.x,r.y,e)}function Ct(r,t){const e=t.x-r.x,o=t.y-r.y;return Math.sqrt(e*e+o*o)<=t.radius+y.HARVEST_DISTANCE}function pt(r,t,e){const s=L.MAX_CAPACITY*r.traits.carryCapacity-r.carriedFood;if(s<=0)return 0;const i=Math.min(s,e),n=t.harvest(i);return r.carriedFood+=n,n}function St(r){const t=L.MAX_CAPACITY*r.traits.carryCapacity;return r.carriedFood>=t}function Z(r,t,e=I.TRAIT_INCREASE_RATE){r.taskAffinity[t]=$(r.taskAffinity[t]+e,I.MIN_TRAIT_VALUE,I.MAX_TRAIT_VALUE)}function _t(r,t=I.TRAIT_DECAY_RATE){if(r>1){const e=r-t;return Math.max(1,e)}else if(r<1){const e=r+t;return Math.min(1,e)}return 1}function mt(r,t,e=I.TRAIT_DECAY_RATE){const o=["gathering","nursing","digging","building"];for(const s of o)s!==t&&(r.taskAffinity[s]=_t(r.taskAffinity[s],e))}function Dt(r,t=I.TRAIT_INCREASE_RATE){r.carryCapacity=$(r.carryCapacity+t,I.MIN_TRAIT_VALUE,I.MAX_TRAIT_VALUE)}function yt(r,t=I.TRAIT_INCREASE_RATE){r.pheromoneSensitivity=$(r.pheromoneSensitivity+t,I.MIN_TRAIT_VALUE,I.MAX_TRAIT_VALUE)}class Gt{constructor(t){this.frameCounter=0,this.world=t}update(t){if(this.frameCounter++,this.frameCounter<I.EVOLUTION_UPDATE_INTERVAL)return;this.frameCounter=0;const e=this.world.getAllAnts();for(const o of e)this.updateAntTraits(o,t)}updateAntTraits(t,e){const o=t.state,s=t.traits;let i=null;switch(o){case l.IDLE:i="nursing",Z(s,"nursing",I.TRAIT_INCREASE_RATE*.5);break;case l.WANDERING:i=null;break;case l.FORAGING:i="gathering",Z(s,"gathering",I.TRAIT_INCREASE_RATE),Math.random()<.3&&yt(s,I.TRAIT_INCREASE_RATE*.5);break;case l.RETURNING:t.carriedFood>0&&(i="gathering",Z(s,"gathering",I.TRAIT_INCREASE_RATE),Dt(s,I.TRAIT_INCREASE_RATE*.5));break}mt(s,i,I.TRAIT_DECAY_RATE)}}class it{constructor(t){this.frameCounter=0,this.world=t,this.movementConfig={speed:X.SPEED,changeDirectionInterval:X.CHANGE_DIRECTION_INTERVAL,turnSpeed:X.TURN_SPEED},this.energyAdjustedMovementConfig={...this.movementConfig},this.transitionConfig=st,this.pheromoneBehaviorConfig={sampleDistance:H.SAMPLE_DISTANCE,followStrength:H.FOLLOW_STRENGTH,explorationRandomness:H.EXPLORATION_RANDOMNESS},this.traitEvolutionSystem=new Gt(t)}applyPheromoneGuidedMovement(t,e){const s=tt(t,this.world,this.pheromoneBehaviorConfig.sampleDistance).pheromoneGradients.get(u.FOOD);if(s){const i=j(s,H.GRADIENT_THRESHOLD);if(i!==null)return J(t,i,e.speed,this.pheromoneBehaviorConfig),!0}return!1}tick(t){const e=this.world.getColonies();for(const i of e)i.beginFrame();const o=this.world.getAllAnts(),s=[];for(const i of o)this.updateAntBehavior(i,t)&&s.push(i);for(const i of s)this.world.removeAnt(i);this.world.pheromoneGrid.decay(t,O.FOOD_DECAY_RATE,u.FOOD),this.world.pheromoneGrid.decay(t,O.NEST_DECAY_RATE,u.NEST),this.world.pheromoneGrid.decay(t,O.DANGER_DECAY_RATE,u.DANGER),this.frameCounter++,this.frameCounter>=O.DIFFUSION_UPDATE_INTERVAL&&(this.world.pheromoneGrid.diffuse(u.FOOD,O.DIFFUSION_RATE),this.world.pheromoneGrid.diffuse(u.NEST,O.DIFFUSION_RATE),this.world.pheromoneGrid.diffuse(u.DANGER,O.DIFFUSION_RATE),this.frameCounter=0);for(let i=this.world.foodSources.length-1;i>=0;i--)this.world.foodSources[i].isDepleted()&&(this.world.foodSources.splice(i,1),this.world.spawnFoodSource());for(const i of e)i.finalizeFrame(t);this.traitEvolutionSystem.update(t)}updateAntBehavior(t,e){t.timeSinceDirectionChange+=e,t.timeInCurrentState+=e;const o=this.world.getColony(t.colonyId);if(!o)return!1;if(this.applyEnergyConsumption(t,e),t.energy<=0)return!0;const s=Rt(t,e,this.transitionConfig);s!==t.state&&v(t,s);const i=this.getMovementConfigForAnt(t);switch(t.state){case l.IDLE:t.targetVx=0,t.targetVy=0,this.handleEating(t,o,e);break;case l.WANDERING:const c=tt(t,this.world,this.pheromoneBehaviorConfig.sampleDistance).pheromoneGradients.get(u.FOOD);if(c){const d=j(c,H.GRADIENT_THRESHOLD);if(d!==null){const E=this.getPheromoneBehaviorConfigForAnt(t);J(t,d,i.speed,E)}else t.timeSinceDirectionChange>=i.changeDirectionInterval&&(K(t,i),t.timeSinceDirectionChange=0)}else t.timeSinceDirectionChange>=i.changeDirectionInterval&&(K(t,i),t.timeSinceDirectionChange=0);break;case l.FORAGING:const a=At(t,this.world,B.PERCEPTION_RANGE);if(a.length>0){const d=a[0];Ct(t,d)?(pt(t,d,y.HARVEST_RATE*e),(St(t)||d.isDepleted())&&v(t,l.RETURNING)):Q(t,d.x,d.y,i)}else this.applyPheromoneGuidedMovement(t,i)||(v(t,l.WANDERING),t.timeSinceDirectionChange=0);break;case l.RETURNING:Tt(t,o.x,o.y,W.HOME_ARRIVAL_DISTANCE)?(t.carriedFood>0&&(o.addFood(t.carriedFood),t.carriedFood=0),v(t,l.IDLE),this.handleEating(t,o,e)):Q(t,o.x,o.y,i);break}gt(t,i,e);const n=Nt(t,this.world,B.OBSTACLE_DETECTION_RANGE);return n&&Ot(t,n,i),ft(t,e),It(t,this.world),Et(t,this.world),this.depositPheromones(t),t.energy<=0}depositPheromones(t){switch(t.state){case l.IDLE:break;case l.WANDERING:this.world.pheromoneGrid.deposit(t.x,t.y,u.NEST,O.DEPOSITION_WANDERING);break;case l.FORAGING:t.carriedFood>0?this.world.pheromoneGrid.deposit(t.x,t.y,u.FOOD,O.DEPOSITION_RETURNING):this.world.getFoodSourcesNear(t.x,t.y,B.PERCEPTION_RANGE).length>0&&this.world.pheromoneGrid.deposit(t.x,t.y,u.FOOD,O.DEPOSITION_FORAGING),this.world.pheromoneGrid.deposit(t.x,t.y,u.NEST,O.DEPOSITION_WANDERING);break;case l.RETURNING:t.carriedFood>0&&this.world.pheromoneGrid.deposit(t.x,t.y,u.FOOD,O.DEPOSITION_RETURNING),this.world.pheromoneGrid.deposit(t.x,t.y,u.NEST,O.DEPOSITION_WANDERING);break}}applyEnergyConsumption(t,e){const s=this.getConsumptionRate(t.state)*t.traits.energyEfficiency*e;t.energy=Math.max(0,t.energy-s),t.lastEnergyConsumption=s}getConsumptionRate(t){return A.CONSUMPTION_RATES[t]??0}getMovementConfigForAnt(t){const e=t.energy/A.MAX_ENERGY;let o=1;e>=.8?o=A.SPEED_MULTIPLIERS.WELL_FED:e>=.5?o=A.SPEED_MULTIPLIERS.NORMAL:e>=.25?o=A.SPEED_MULTIPLIERS.HUNGRY:o=A.SPEED_MULTIPLIERS.STARVING;const s=t.traits.movementSpeed;return this.energyAdjustedMovementConfig.speed=this.movementConfig.speed*o*s,this.energyAdjustedMovementConfig.changeDirectionInterval=this.movementConfig.changeDirectionInterval,this.energyAdjustedMovementConfig.turnSpeed=this.movementConfig.turnSpeed,this.energyAdjustedMovementConfig}getPheromoneBehaviorConfigForAnt(t){return{sampleDistance:this.pheromoneBehaviorConfig.sampleDistance,followStrength:this.pheromoneBehaviorConfig.followStrength*t.traits.pheromoneSensitivity,explorationRandomness:this.pheromoneBehaviorConfig.explorationRandomness}}handleEating(t,e,o){if(t.energy>=A.MAX_ENERGY)return;const s=A.EATING_RECOVERY_RATE/A.FOOD_CONSUMPTION_RATE,n=(A.MAX_ENERGY-t.energy)/s,h=A.FOOD_CONSUMPTION_RATE*o,c=Math.min(n,h),a=e.consumeFood(c);if(a>0){const d=a*s;t.energy=Math.min(A.MAX_ENERGY,t.energy+d)}}update(t){this.tick(t)}initializeWorld(t){const e=t??P.INITIAL_ANT_COUNT,o=this.world.createColony(this.world.width/2,this.world.height/2);for(let s=0;s<e;s++){const i=this.world.spawnAnt(o);K(i,this.movementConfig)}for(let s=0;s<10;s++)this.world.spawnFoodSource()}}function xt(r){const{taskAffinity:t,movementSpeed:e,pheromoneSensitivity:o,carryCapacity:s,wanderingRadius:i,energyEfficiency:n}=r,h=I.HIGH_AFFINITY_THRESHOLD;return t.gathering>h&&e>1.1&&o>1.2&&s>1.2?"Food Gatherer":t.nursing>h&&i<.8&&n<.9&&e<.9?"Nursery Worker":(t.building>h||t.digging>h)&&e<.9&&o<.8?"Builder":"Generalist"}function Mt(r){switch(r){case"Food Gatherer":return 4881486;case"Nursery Worker":return 13935988;case"Builder":return 9137991;case"Generalist":default:return 8421504}}class rt{constructor(t,e){this.traitVisualizationEnabled=!1,this.graphics=t.add.graphics(),this.theme=e||C.default}setDepth(t){this.graphics.setDepth(t)}setTraitVisualization(t){this.traitVisualizationEnabled=t}render(t,e){e!==void 0&&(this.traitVisualizationEnabled=e),this.graphics.clear();for(const o of t)this.drawAnt(o)}drawAnt(t){const e=Math.sqrt(t.vx*t.vx+t.vy*t.vy);let o=0,s=0;if(e>0){const n=t.vx/e,h=t.vy/e;o=n*(G.BODY_RADIUS+G.HEAD_RADIUS),s=h*(G.BODY_RADIUS+G.HEAD_RADIUS)}let i;if(this.traitVisualizationEnabled){const n=xt(t.traits);i=Mt(n)}else{const h={[l.IDLE]:"idle",[l.WANDERING]:"wandering",[l.FORAGING]:"foraging",[l.RETURNING]:"returning"}[t.state]||"wandering";i=this.theme.antColors[h]}if(this.graphics.fillStyle(i,1),this.graphics.fillCircle(t.x,t.y,G.BODY_RADIUS),this.graphics.fillStyle(G.HEAD_COLOR,1),this.graphics.fillCircle(t.x+o,t.y+s,G.HEAD_RADIUS),t.carriedFood>0){const n=L.MAX_CAPACITY*t.traits.carryCapacity,h=t.carriedFood/n,c=L.CARRYING_INDICATOR_RADIUS*h;this.graphics.fillStyle(L.CARRYING_INDICATOR_COLOR,.8),this.graphics.fillCircle(t.x,t.y,c)}}destroy(){this.graphics.destroy()}}class nt{constructor(t,e){this.graphics=t.add.graphics(),this.theme=e||C.default}setDepth(t){this.graphics.setDepth(t)}render(t){this.graphics.clear();for(const e of t)this.drawColony(e)}drawColony(t){this.graphics.fillStyle(this.theme.colonyColors.nest,x.NEST_OPACITY),this.graphics.fillCircle(t.x,t.y,x.NEST_RADIUS),this.graphics.lineStyle(x.NEST_BORDER_WIDTH,this.theme.colonyColors.border,1),this.graphics.strokeCircle(t.x,t.y,x.NEST_RADIUS),this.graphics.fillStyle(this.theme.colonyColors.entrance,x.ENTRANCE_OPACITY),this.graphics.fillCircle(t.x,t.y,x.NEST_RADIUS*x.ENTRANCE_RADIUS_MULTIPLIER)}destroy(){this.graphics.destroy()}}class Pt extends f.Scene{constructor(){super({key:"MenuScene"}),this.isConfigOpen=!1,this.themeDots=new Map,this.selectedAntCount=40,this.selectedTheme="default",this.previousAntCount=40,this.previousTheme="default",this.isDraggingSlider=!1}create(){const t=C[this.selectedTheme];this.cameras.main.setBackgroundColor(t.backgroundColor),this.initializeBackgroundSimulation(),this.createUI(),this.createConfigPanel(),this.setupKeyboardShortcuts()}initializeBackgroundSimulation(){const t=this.scale.width,e=this.scale.height;this.world=new et(t,e),this.simulationSystem=new it(this.world);const o=t/2,s=e/2,i=this.world.createColony(o,s);for(let h=0;h<g.BACKGROUND_SIM.ANT_COUNT;h++)this.world.spawnAnt(i);const n=C[this.selectedTheme];this.antRenderer=new rt(this,n),this.colonyRenderer=new nt(this,n),this.antRenderer.setDepth(g.DEPTHS.BACKGROUND),this.colonyRenderer.setDepth(g.DEPTHS.BACKGROUND)}createUI(){const t=this.scale.width/2,e=C[this.selectedTheme];this.titleText=this.add.text(t,g.TITLE.Y_POSITION,g.TITLE.TEXT,{fontSize:g.TITLE.FONT_SIZE,color:e.uiColors.title,fontStyle:"bold"}).setOrigin(.5).setDepth(g.DEPTHS.UI_BASE),this.taglineText=this.add.text(t,g.TAGLINE.Y_POSITION,g.TAGLINE.TEXT,{fontSize:g.TAGLINE.FONT_SIZE,color:e.uiColors.text,fontStyle:"italic"}).setOrigin(.5).setDepth(g.DEPTHS.UI_BASE),this.createStartButton(t),this.configButton=this.add.text(t,g.CONFIG_BUTTON.Y_POSITION,g.CONFIG_BUTTON.TEXT,{fontSize:g.CONFIG_BUTTON.FONT_SIZE,color:e.uiColors.text}).setOrigin(.5).setDepth(g.DEPTHS.UI_BASE).setInteractive({useHandCursor:!0}).on("pointerover",()=>{this.configButton.setStyle({color:e.uiColors.title})}).on("pointerout",()=>{this.configButton.setStyle({color:e.uiColors.text})}).on("pointerdown",()=>{this.toggleConfigPanel()})}createStartButton(t){const e=C[this.selectedTheme],o=g.START_BUTTON;this.startButton=this.add.container(t,o.Y_POSITION);const s=this.add.text(0,0,o.TEXT,{fontSize:o.FONT_SIZE}),i=s.width,n=s.height;s.destroy();const h=i+o.PADDING.x*2,c=n+o.PADDING.y*2,a=this.add.rectangle(0,0,h,c).setStrokeStyle(o.BORDER_WIDTH,f.Display.Color.HexStringToColor(o.BORDER_COLOR).color).setFillStyle(f.Display.Color.HexStringToColor(o.BACKGROUND_COLOR).color),d=this.add.text(0,0,o.TEXT,{fontSize:o.FONT_SIZE,color:e.uiColors.title,fontStyle:"bold"}).setOrigin(.5);this.startButton.add([a,d]),this.startButton.setDepth(g.DEPTHS.UI_BASE),this.startButton.setSize(h,c),this.startButton.setInteractive({useHandCursor:!0}),this.startButton.on("pointerover",()=>{a.setFillStyle(f.Display.Color.HexStringToColor(o.HOVER_COLOR).color),this.startButton.setScale(1.05)}),this.startButton.on("pointerout",()=>{a.setFillStyle(f.Display.Color.HexStringToColor(o.BACKGROUND_COLOR).color),this.startButton.setScale(1)}),this.startButton.on("pointerdown",()=>{this.startSimulation()})}createConfigPanel(){const t=this.scale.width/2,e=this.scale.height/2,o=g.CONFIG_PANEL,s=C[this.selectedTheme];this.configOverlay=this.add.rectangle(0,0,this.scale.width,this.scale.height,0,.7).setOrigin(0).setDepth(g.DEPTHS.CONFIG_OVERLAY).setVisible(!1).setInteractive().on("pointerdown",()=>{this.toggleConfigPanel()}),this.configPanel=this.add.container(t,e),this.configPanel.setDepth(g.DEPTHS.CONFIG_PANEL),this.configPanel.setVisible(!1);const i=this.add.rectangle(0,0,o.WIDTH,o.HEIGHT,o.BACKGROUND_COLOR,o.BACKGROUND_ALPHA).setStrokeStyle(o.BORDER_WIDTH,o.BORDER_COLOR),n=this.add.text(0,-450/2+40,"Configuration",{fontSize:"32px",color:s.uiColors.title,fontStyle:"bold"}).setOrigin(.5),h=this.add.text(-500/2+o.PADDING,-120,"Starting Ants:",{fontSize:"20px",color:s.uiColors.text}).setOrigin(0),c=this.add.text(-500/2+o.PADDING,20,"Theme:",{fontSize:"20px",color:s.uiColors.text}).setOrigin(0);this.configPanel.add([i,n,h,c]),this.createSlider(-500/2+o.PADDING,-80),this.createThemeSelector(-500/2+o.PADDING,60),this.createPanelButton("Apply",-80,180).on("pointerdown",()=>{this.toggleConfigPanel()}),this.createPanelButton("Cancel",80,180).on("pointerdown",()=>{this.selectedAntCount=this.previousAntCount,this.selectedTheme=this.previousTheme,this.updateSliderPosition(),this.updateThemeSelector(),this.toggleConfigPanel()})}createSlider(t,e){const o=g.SLIDER,s=C[this.selectedTheme],i=this.add.rectangle(t,e,o.WIDTH,o.HEIGHT,o.TRACK_COLOR).setOrigin(0,.5);this.sliderHandle=this.add.circle(t,e,o.HANDLE_RADIUS,o.HANDLE_COLOR),this.sliderHandle.setInteractive({useHandCursor:!0,draggable:!0}),this.sliderValueText=this.add.text(t+o.WIDTH+20,e,"40",{fontSize:"24px",color:s.uiColors.text,fontStyle:"bold"}).setOrigin(0,.5);const n=this.add.text(t,e+25,"10",{fontSize:"14px",color:s.uiColors.textDim}).setOrigin(0,0),h=this.add.text(t+o.WIDTH,e+25,"100",{fontSize:"14px",color:s.uiColors.textDim}).setOrigin(1,0);this.sliderHandle.on("pointerover",()=>{this.sliderHandle.setFillStyle(o.HANDLE_HOVER_COLOR)}),this.sliderHandle.on("pointerout",()=>{this.isDraggingSlider||this.sliderHandle.setFillStyle(o.HANDLE_COLOR)}),this.sliderHandle.on("dragstart",()=>{this.isDraggingSlider=!0,this.sliderHandle.setFillStyle(o.HANDLE_HOVER_COLOR)}),this.sliderHandle.on("drag",(c,a)=>{const d=t,E=t+o.WIDTH,R=f.Math.Clamp(a,d,E);this.sliderHandle.x=R;const m=10+(R-d)/o.WIDTH*90;this.selectedAntCount=Math.round(m/5)*5,this.sliderValueText.setText(this.selectedAntCount.toString())}),this.sliderHandle.on("dragend",()=>{this.isDraggingSlider=!1,this.sliderHandle.setFillStyle(o.HANDLE_COLOR)}),this.configPanel.add([i,this.sliderHandle,this.sliderValueText,n,h]),this.updateSliderPosition()}updateSliderPosition(){const t=g.SLIDER,e=-500/2+g.CONFIG_PANEL.PADDING,o=(this.selectedAntCount-10)/90,s=e+o*t.WIDTH;this.sliderHandle.x=s,this.sliderValueText.setText(this.selectedAntCount.toString())}createThemeSelector(t,e){const o=C[this.selectedTheme],s=["default","highContrast","blackWhite"],i=35;s.forEach((n,h)=>{const c=C[n],a=e+h*i,d=this.add.circle(t,a,8).setStrokeStyle(2,f.Display.Color.HexStringToColor(o.uiColors.text).color).setFillStyle(0,0),E=this.add.circle(t,a,5,f.Display.Color.HexStringToColor(o.uiColors.title).color).setVisible(n===this.selectedTheme),R=this.add.text(t+20,a,c.name,{fontSize:"18px",color:o.uiColors.text}).setOrigin(0,.5),p=this.add.rectangle(t,a,200,i,0,0).setOrigin(0,.5).setInteractive({useHandCursor:!0});p.on("pointerdown",()=>{this.selectedTheme=n,this.updateThemeSelector()}),p.on("pointerover",()=>{R.setStyle({color:o.uiColors.title})}),p.on("pointerout",()=>{R.setStyle({color:o.uiColors.text})}),this.configPanel.add([d,E,R,p]),this.themeDots.set(n,E)})}updateThemeSelector(){this.themeDots.forEach((t,e)=>{t.setVisible(e===this.selectedTheme)})}createPanelButton(t,e,o){const s=C[this.selectedTheme],i=this.add.container(e,o),n=this.add.rectangle(0,0,120,45).setStrokeStyle(2,f.Display.Color.HexStringToColor(g.START_BUTTON.BORDER_COLOR).color).setFillStyle(f.Display.Color.HexStringToColor(g.START_BUTTON.BACKGROUND_COLOR).color),h=this.add.text(0,0,t,{fontSize:"20px",color:s.uiColors.title,fontStyle:"bold"}).setOrigin(.5);return i.add([n,h]),i.setSize(120,45),i.setInteractive({useHandCursor:!0}),i.on("pointerover",()=>{n.setFillStyle(f.Display.Color.HexStringToColor(g.START_BUTTON.HOVER_COLOR).color),i.setScale(1.05)}),i.on("pointerout",()=>{n.setFillStyle(f.Display.Color.HexStringToColor(g.START_BUTTON.BACKGROUND_COLOR).color),i.setScale(1)}),this.configPanel.add(i),i}toggleConfigPanel(){this.isConfigOpen=!this.isConfigOpen,this.isConfigOpen?(this.previousAntCount=this.selectedAntCount,this.previousTheme=this.selectedTheme,this.configOverlay.setVisible(!0),this.configPanel.setVisible(!0),this.configPanel.setAlpha(0),this.configPanel.setY(this.scale.height/2-30),this.tweens.add({targets:this.configPanel,alpha:1,y:this.scale.height/2,duration:300,ease:"Power2"})):this.tweens.add({targets:this.configPanel,alpha:0,y:this.scale.height/2+30,duration:200,ease:"Power2",onComplete:()=>{this.configPanel.setVisible(!1),this.configOverlay.setVisible(!1)}})}setupKeyboardShortcuts(){var t,e;(t=this.input.keyboard)==null||t.on("keydown-ESC",()=>{this.isConfigOpen&&(this.selectedAntCount=this.previousAntCount,this.selectedTheme=this.previousTheme,this.updateSliderPosition(),this.updateThemeSelector(),this.toggleConfigPanel())}),(e=this.input.keyboard)==null||e.on("keydown-ENTER",()=>{this.isConfigOpen||this.startSimulation()})}startSimulation(){const t={antCount:this.selectedAntCount,theme:this.selectedTheme};this.scene.start("MainScene",t)}update(t,e){const o=e/1e3;this.simulationSystem.update(o),this.colonyRenderer.render(this.world.getColonies()),this.antRenderer.render(this.world.getAllAnts())}shutdown(){this.antRenderer&&this.antRenderer.destroy(),this.colonyRenderer&&this.colonyRenderer.destroy(),this.input.keyboard&&(this.input.keyboard.off("keydown-ESC"),this.input.keyboard.off("keydown-ENTER"))}}class Ft{constructor(t,e){this.graphics=t.add.graphics(),this.theme=e||C.default}render(t){this.graphics.clear();for(const e of t)this.graphics.fillStyle(this.theme.obstacleColor,1),this.graphics.fillCircle(e.x,e.y,e.radius),this.graphics.lineStyle(2,0,1),this.graphics.strokeCircle(e.x,e.y,e.radius)}destroy(){this.graphics.destroy()}}class Ht{constructor(t,e){this.scene=t,this.graphics=t.add.graphics(),this.graphics.setDepth(dt.PHEROMONE_DEPTH),this.visible=!1,this.graphics.setVisible(!1),this.theme=e||C.default}render(t){if(!this.visible)return;this.graphics.clear();const e=t.getGridWidth(),o=t.getGridHeight(),s=t.getCellSize();this.renderPheromoneType(t,u.NEST,e,o,s,this.theme.pheromoneColors.nest),this.renderPheromoneType(t,u.FOOD,e,o,s,this.theme.pheromoneColors.food),this.renderPheromoneType(t,u.DANGER,e,o,s,this.theme.pheromoneColors.danger)}renderPheromoneType(t,e,o,s,i,n){const h=t.getGrid(e);if(!h)return;const c=n>>16&255,a=n>>8&255,d=n&255,E=this.scene.cameras.main.worldView,R=Math.max(0,Math.floor(E.x/i)),p=Math.max(0,Math.floor(E.y/i)),m=Math.min(o,Math.ceil((E.x+E.width)/i)),N=Math.min(s,Math.ceil((E.y+E.height)/i));for(let _=p;_<N;_++)for(let F=R;F<m;F++){const V=_*o+F,D=h[V];if(D>O.RENDER_THRESHOLD){const U=Math.min(D/O.MAX_STRENGTH,1),Y=Math.pow(U,O.VISUALIZATION_POWER)*O.MAX_OPACITY,k=F*i,b=_*i,ht=f.Display.Color.GetColor(c,a,d);this.graphics.fillStyle(ht,Y),this.graphics.fillRect(k,b,i,i)}}}toggle(){this.visible=!this.visible,this.graphics.setVisible(this.visible),this.visible||this.graphics.clear()}setVisible(t){this.visible=t,this.graphics.setVisible(t),t||this.graphics.clear()}isVisible(){return this.visible}destroy(){this.graphics.destroy()}}class wt{constructor(t,e){this.graphics=t.add.graphics({x:0,y:0}),this.theme=e||C.default}render(t){if(this.graphics.clear(),!(!t||t.length===0))for(const e of t){const o=Math.min(e.foodAmount/y.INITIAL_FOOD_AMOUNT,1),s=Math.max(.5,o);this.graphics.lineStyle(3,this.theme.foodColors.border,s),this.graphics.strokeCircleShape(new f.Geom.Circle(e.x,e.y,e.radius+1)),this.graphics.fillStyle(this.theme.foodColors.food,s),this.graphics.fillCircleShape(new f.Geom.Circle(e.x,e.y,e.radius))}}getGraphics(){return this.graphics}destroy(){this.graphics.destroy()}}class Lt{constructor(t,e,o){this.x=t,this.y=e,this.radius=o}containsPoint(t,e){const o=t-this.x,s=e-this.y;return o*o+s*s<=this.radius*this.radius}distanceToEdge(t,e){const o=t-this.x,s=e-this.y;return Math.sqrt(o*o+s*s)-this.radius}}class Ut extends f.Scene{constructor(){super({key:"MainScene"}),this.traitOverlayEnabled=!1}create(){var c,a,d,E,R,p,m;const t=this.scene.settings.data,e=(t==null?void 0:t.antCount)??P.INITIAL_ANT_COUNT,o=(t==null?void 0:t.theme)??"default";this.currentTheme=C[o],this.cameras.main.setBackgroundColor(this.currentTheme.backgroundColor);const s=P.WORLD_WIDTH,i=P.WORLD_HEIGHT;if(this.world=new et(s,i),this.simulationSystem=new it(this.world),this.simulationSystem.initializeWorld(e),this.addTestObstacles(),this.antRenderer=new rt(this,this.currentTheme),this.colonyRenderer=new nt(this,this.currentTheme),this.obstacleRenderer=new Ft(this,this.currentTheme),this.pheromoneRenderer=new Ht(this,this.currentTheme),this.foodSourceRenderer=new wt(this,this.currentTheme),this.cameras.main.setBounds(0,0,s,i),this.cameras.main.centerOn(s/2,i/2),this.input.keyboard){const N=this.input.keyboard;this.panKeys={up:N.addKey(f.Input.Keyboard.KeyCodes.W),down:N.addKey(f.Input.Keyboard.KeyCodes.S),left:N.addKey(f.Input.Keyboard.KeyCodes.A),right:N.addKey(f.Input.Keyboard.KeyCodes.D)}}this.wheelHandler=(N,_,F,V)=>{const D=this.cameras.main,U=D.getWorldPoint(N.x,N.y),Y=V>0?1-S.ZOOM_STEP:1+S.ZOOM_STEP,k=f.Math.Clamp(D.zoom*Y,S.MIN_ZOOM,S.MAX_ZOOM);D.setZoom(k);const b=D.getWorldPoint(N.x,N.y);D.scrollX+=U.x-b.x,D.scrollY+=U.y-b.y},this.input.on("wheel",this.wheelHandler),this.titleText=this.add.text(T.TITLE.X,T.TITLE.Y,T.TITLE.TEXT,{fontSize:T.TITLE.FONT_SIZE,color:this.currentTheme.uiColors.title,fontStyle:"bold"}).setDepth(T.UI_DEPTH),this.instructionsText=this.add.text(T.INSTRUCTIONS.X,T.INSTRUCTIONS.Y,T.INSTRUCTIONS.TEXT,{fontSize:T.INSTRUCTIONS.FONT_SIZE,color:this.currentTheme.uiColors.text}).setDepth(T.UI_DEPTH);const n=this.generateLegendText();this.legendText=this.add.text(T.LEGEND.X,T.LEGEND.Y,n,{fontSize:T.LEGEND.FONT_SIZE,color:this.currentTheme.uiColors.textDim}).setDepth(T.UI_DEPTH),this.pheromoneOverlayText=this.add.text(T.LEGEND.X,T.LEGEND.Y+20,"Press P to toggle pheromone overlay (OFF) | Press Y to toggle trait visualization (OFF)",{fontSize:T.LEGEND.FONT_SIZE,color:this.currentTheme.uiColors.textDim}).setDepth(T.UI_DEPTH),this.debugText=this.add.text(T.DEBUG.X,this.scale.height-T.DEBUG.Y_OFFSET_FROM_BOTTOM,"",{fontSize:T.DEBUG.FONT_SIZE,color:this.currentTheme.uiColors.text,backgroundColor:T.DEBUG.BACKGROUND_COLOR,padding:T.DEBUG.PADDING}).setDepth(T.UI_DEPTH),this.metricsText=this.add.text(T.DEBUG.X,this.scale.height-T.DEBUG.Y_OFFSET_FROM_BOTTOM-30,"",{fontSize:T.DEBUG.FONT_SIZE,color:this.currentTheme.uiColors.text,backgroundColor:T.DEBUG.BACKGROUND_COLOR,padding:T.DEBUG.PADDING}).setDepth(T.UI_DEPTH),this.hudCamera=this.cameras.add(0,0,this.scale.width,this.scale.height);const h=[this.titleText,this.instructionsText,this.legendText,this.pheromoneOverlayText,this.debugText,this.metricsText];this.cameras.main.ignore(h);for(const N of this.children.list)h.includes(N)||this.hudCamera.ignore(N);(c=this.input.keyboard)==null||c.on("keydown-P",()=>{this.pheromoneRenderer.toggle(),this.updatePheromoneOverlayText()}),(a=this.input.keyboard)==null||a.on("keydown-Y",()=>{this.traitOverlayEnabled=!this.traitOverlayEnabled,this.updatePheromoneOverlayText()}),(d=this.input.keyboard)==null||d.on("keydown-T",()=>{this.depositTestPheromones()}),(E=this.input.keyboard)==null||E.on("keydown-MINUS",()=>{const N=this.cameras.main,_=f.Math.Clamp(N.zoom*(1-S.ZOOM_STEP),S.MIN_ZOOM,S.MAX_ZOOM);N.setZoom(_)}),(R=this.input.keyboard)==null||R.on("keydown-PLUS",()=>{const N=this.cameras.main,_=f.Math.Clamp(N.zoom*(1+S.ZOOM_STEP),S.MIN_ZOOM,S.MAX_ZOOM);N.setZoom(_)}),(p=this.input.keyboard)==null||p.on("keydown-R",()=>{this.returnToMenu()}),(m=this.input.mouse)==null||m.disableContextMenu()}update(t,e){const o=e/1e3,s=this.cameras.main;if(this.panKeys){const n=S.PAN_SPEED/s.zoom*o;this.panKeys.up.isDown&&(s.scrollY-=n),this.panKeys.down.isDown&&(s.scrollY+=n),this.panKeys.left.isDown&&(s.scrollX-=n),this.panKeys.right.isDown&&(s.scrollX+=n)}this.simulationSystem.update(o),this.pheromoneRenderer.isVisible()&&this.pheromoneRenderer.render(this.world.pheromoneGrid),this.obstacleRenderer.render(this.world.getObstacles()),this.colonyRenderer.render(this.world.getColonies()),this.foodSourceRenderer.render(this.world.foodSources);const i=this.world.getAllAnts();this.antRenderer.render(i,this.traitOverlayEnabled),this.updateDebugUI(i),this.updateMetricsUI(),this.handleTestPheromoneDeposition()}updatePheromoneOverlayText(){const t=this.pheromoneRenderer.isVisible()?"ON":"OFF",e=this.traitOverlayEnabled?"ON":"OFF";this.pheromoneOverlayText.setText(`Press P to toggle pheromone overlay (${t}) | Press Y to toggle trait visualization (${e})`)}handleTestPheromoneDeposition(){const t=this.input.activePointer;t.leftButtonDown()&&this.world.pheromoneGrid.deposit(t.worldX,t.worldY,u.FOOD,.5),t.rightButtonDown()&&this.world.pheromoneGrid.deposit(t.worldX,t.worldY,u.NEST,.5),t.middleButtonDown()&&this.world.pheromoneGrid.deposit(t.worldX,t.worldY,u.DANGER,.5)}generateLegendText(){const t=this.currentTheme.antColors,e=h=>{const c=h>>16&255,a=h>>8&255,d=h&255;return c<80&&a<80&&d<80?"Dark Gray":c>200&&a>200&&d>200?"White":Math.abs(c-a)<30&&Math.abs(a-d)<30?c<100?"Dark Gray":c<150?"Gray":"Light Gray":c>a&&c>d?a>100&&d<100?"Orange":d>100?"Pink":"Red":a>c&&a>d?"Green":d>c&&d>a?"Blue":c>150&&a>100&&d<100?"Brown":a>150&&d>150?"Cyan":"Gray"},o=e(t.idle),s=e(t.wandering),i=e(t.foraging),n=e(t.returning);return`Colors: ${o}=Idle, ${s}=Wandering, ${i}=Foraging, ${n}=Returning`}depositTestPheromones(){const t=this.world.width/2,e=this.world.height/2;for(let o=0;o<150;o++)this.world.pheromoneGrid.deposit(t-75+o,e-100,u.FOOD,3);for(let o=0;o<150;o++)this.world.pheromoneGrid.deposit(t-75+o,e,u.NEST,3);for(let o=0;o<60;o++)for(let s=0;s<60;s++)this.world.pheromoneGrid.deposit(t-30+o,e+50+s,u.DANGER,2);console.log("Test pheromones deposited! You should see red, blue, and yellow patterns.")}updateDebugUI(t){const e={[l.IDLE]:0,[l.WANDERING]:0,[l.FORAGING]:0,[l.RETURNING]:0};for(const s of t)e[s.state]++;const o=[`Total: ${t.length}`,`Idle: ${e[l.IDLE]}`,`Wandering: ${e[l.WANDERING]}`,`Foraging: ${e[l.FORAGING]}`,`Returning: ${e[l.RETURNING]}`].join(" | ");this.debugText.setText(o)}updateMetricsUI(){const t=this.world.getColonies()[0];if(!t)return;const e=t.getHealthStatus(),o=t.surplusRate,s=o>=0?`+${o.toFixed(2)}`:`${o.toFixed(2)}`,i=[`Food: ${t.foodStored.toFixed(1)}`,`Eaten: ${t.foodConsumedRate.toFixed(2)}/s`,`Gathered: ${t.foodGatheredRate.toFixed(2)}/s`,`Surplus: ${s}/s`,`Status: ${e}`].join(" | ");this.metricsText.setText(i)}addTestObstacles(){const s=this.world.width/2,i=this.world.height/2,n=200,h=[];for(let c=0;h.length<60&&c<60*10;c++){const a=20+Math.random()*40,d=a+Math.random()*(this.world.width-a*2),E=a+Math.random()*(this.world.height-a*2);if(Math.hypot(d-s,E-i)<n+a)continue;let p=!1;for(const N of h)if(Math.hypot(d-N.x,E-N.y)<a+N.radius+10){p=!0;break}if(p)continue;const m=new Lt(d,E,a);h.push(m),this.world.addObstacle(m)}}returnToMenu(){this.shutdown(),this.scene.start("MenuScene")}shutdown(){this.wheelHandler&&this.input.off("wheel",this.wheelHandler),this.hudCamera&&this.cameras.remove(this.hudCamera),this.antRenderer.destroy(),this.colonyRenderer.destroy(),this.obstacleRenderer.destroy(),this.pheromoneRenderer.destroy()}}const bt={type:f.AUTO,width:w.CANVAS_WIDTH,height:w.CANVAS_HEIGHT,parent:"game-container",backgroundColor:w.BACKGROUND_COLOR,scene:[Pt,Ut],scale:{mode:f.Scale.FIT,autoCenter:f.Scale.CENTER_BOTH}};new f.Game(bt);
